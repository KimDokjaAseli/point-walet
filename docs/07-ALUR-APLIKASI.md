# BAB 7: ALUR APLIKASI

## 7.1 User Flow

### 7.1.1 Login Per Role

```
┌─────────────────────────────────────────────────────────────────┐
│                      HALAMAN UTAMA                               │
│                                                                  │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │          🎓 WALLET POINT GAMIFIKASI                      │  │
│   │                                                          │  │
│   │                            │  │
│   │                                                          │  │
│   │   ┌──────────────────────────────────────┐              │  │
│   │   │                                      │              │  │
│   │   │             LOGIN                    │              │  │
│   │   │                                      │              │  │
│   │   └────┬─────────────┬─────────────┬─────┘              │  │
│   │        │             │             │                     │  │
│   └────────┼─────────────┼─────────────┼─────────────────────┘  │
│            │             │             │                        │
│            ▼             ▼             ▼                        │
│   ┌────────────┐  ┌────────────┐  ┌────────────┐               │
│   │LOGIN ADMIN │  │LOGIN DOSEN │  │LOGIN MHS   │               │
│   │/login/admin│  │/login/dosen│  │/login/mhs  │               │
│   └────────────┘  └────────────┘  └────────────┘               │
└─────────────────────────────────────────────────────────────────┘
```

### 7.1.2 Flow Mahasiswa: Misi → Poin → QR Payment

```
┌─────────────────────────────────────────────────────────────────┐
│                    FLOW MAHASISWA                                │
└─────────────────────────────────────────────────────────────────┘

  ┌─────────────┐
  │   LOGIN     │
  │  Mahasiswa  │
  └──────┬──────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────┐
  │                    DASHBOARD MAHASISWA                       │
  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │
  │  │ Saldo: 5,000 pts│  │ Aktivitas Terbaru(Contoh)               │   │
  │  │ 🔒 Locked: 0    │  │ • Quiz Selesai (+100 pts)       │   │
  │  └─────────────────┘  │ • Beli E-Book (-500 pts)        │   │
  │                       └─────────────────────────────────┘   │
  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐              │
  │  │Wallet│ │ Misi │ │ Scan │ │Market│ │TopUp │              │
  │  └──┬───┘ └──┬───┘ └──┬───┘ └──┬───┘ └──┬───┘              │
  └─────┼────────┼────────┼────────┼────────┼───────────────────┘
        │        │        │        │        │
        │        ▼        │        │        │
        │  ┌───────────┐  │        │        │
        │  │DAFTAR MISI│  │        │        │
        │  │(dibuat    │  │        │        │
        │  │    dosen) │  │        │        │
        │  │           │  │        │        │
        │  │ • Quiz 1  │  │        │        │
        │  │ • Quiz 2  │  │        │        │
        │  │ • Project │  │        │        │
        │  └─────┬─────┘  │        │        │
        │        │        │        │        │
        │        ▼        │        │        │
        │  ┌───────────┐  │        │        │
        │  │KERJAKAN   │  │        │        │
        │  │MISI/QUIZ  │  │        │        │
        │  └─────┬─────┘  │        │        │
        │        │        │        │        │
        │        ▼        │        │        │
        │  ┌───────────┐  │        │        │
        │  │ SELESAI!  │  │        │        │
        │  │ +100 Poin │──┼────────┼────────┼─────────┐
        │  └───────────┘  │        │        │         │
        │                 │        │        │         │
        ▼                 │        ▼        │         │
  ┌───────────┐           │  ┌───────────┐  │         │
  │  WALLET   │◄──────────┼──│MARKETPLACE│  │         │
  │           │           │  │           │  │         │
  │ Saldo:    │           │  │ • E-Books │  │         │
  │ 5,100 pts │           │  │ • Courses │  │         │
  │           │           │  │ • Materi  │  │         │
  └───────────┘           │  └─────┬─────┘  │         │
                          │        │        │         │
                          │        ▼        │         │
                          │  ┌───────────┐  │         │
                          │  │ CHECKOUT  │  │         │
                          │  │ via QR(generate by sistem)    │  │         │
                          │  └─────┬─────┘  │         │
                          │        │        │         │
                          ▼        ▼        ▼         │
                    ┌───────────────────────────┐     │
                    │      QR SCANNER           │     │
                    │                           │     │
                    │   📷 Scan QR Code         │     │
                    │                           │     │
                    │   Jumlah: 500 pts         │     │
                    │   [BAYAR]                 │     │
                    └─────────────┬─────────────┘     │
                                  │                   │
                                  ▼                   │
                    ┌───────────────────────────┐     │
                    │   PEMBAYARAN BERHASIL!    │◄────┘
                    │                           │
                    │   Saldo baru: 4,600 pts   │
                    └───────────────────────────┘
```

### 7.1.3 Flow Dosen: Buat QR → Terima Poin

```
┌─────────────────────────────────────────────────────────────────┐
│                      FLOW DOSEN                                  │
└─────────────────────────────────────────────────────────────────┘

  ┌─────────────┐
  │   LOGIN     │
  │   Dosen     │
  └──────┬──────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────┐
  │                    DASHBOARD DOSEN                           │
  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │
  │  │ Saldo: 12,500   │  │ Penjualan Terbaru              │   │
  │  │ Pendapatan hari │  │ • E-Book (+500 pts)            │   │
  │  │ ini: 1,500 pts  │  │ • Course (+2,000 pts)          │   │
  │  └─────────────────┘  └─────────────────────────────────┘   │
  │                                                              │
  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                        │
  │  │Buat  │ │Kelola│ │Produk│ │Wallet│                        │
  │  │ QR   │ │ Misi │ │      │ │      │                        │
  │  └──┬───┘ └──┬───┘ └──┬───┘ └──────┘                        │
  └─────┼────────┼────────┼─────────────────────────────────────┘
        │        │        │
        ▼        │        ▼
  ┌───────────┐  │  ┌───────────────┐
  │ BUAT QR   │  │  │ KELOLA PRODUK │
  │           │  │  │               │
  │ Jumlah:   │  │  │ • Tambah      │
  │ [1000]pts │  │  │ • Edit        │
  │           │  │  │ • Hapus       │
  │ Deskripsi │  │  │ • Lihat Status penjualan │
  │ [       ] │  │  └───────────────┘
  │           │  │
  │ [GENERATE]│  ▼
  └─────┬─────┘  ┌───────────────┐
        │        │ KELOLA MISI   │
        ▼        │               │
  ┌───────────┐  │ • Buat Quiz dan membuat jawaban dari quiz   │
  │  QR CODE  │  │ • Lihat Hasil pengerjaan mahasiswa │
  │           │  │ • Grade       │
  │  [QR IMG] │  └───────────────┘
  │           │
  │ Exp: 9:45 │
  │           │
  │ Menunggu  │
  │ scan...   │
  └─────┬─────┘
        │
        │ (Mahasiswa scan)
        ▼
  ┌───────────────┐
  │ NOTIFIKASI    │
  │               │
  │ Pembayaran    │
  │ diterima!     │
  │ +1,000 pts    │
  │               │
  │ Saldo baru:   │
  │ 13,500 pts    │
  └───────────────┘
```

### 7.1.4 Flow Admin: Monitoring & Audit

```
┌─────────────────────────────────────────────────────────────────┐
│                      FLOW ADMIN                                  │
└─────────────────────────────────────────────────────────────────┘

  ┌─────────────┐
  │   LOGIN     │
  │   Admin     │
  └──────┬──────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────┐
  │                    DASHBOARD ADMIN                           │
  │                                                              │
  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐         │
  │  │ Total Users  │ │ Transaksi    │ │ Poin Beredar │         │
  │  │    1,250     │ │ Hari ini: 89 │ │   2.5 Juta   │         │
  │  └──────────────┘ └──────────────┘ └──────────────┘         │
  │                                                              │
  │  ┌──────────────────────────────────────────────────────┐   │
  │  │ Alert: 2 transaksi high-risk terdeteksi             │   │
  │  └──────────────────────────────────────────────────────┘   │
  │                                                              │
  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐              │
  │  │Users │ │Audit │ │Rekon │ │Imprsn│ │Report│              │
  │  └──┬───┘ └──┬───┘ └──┬───┘ └──┬───┘ └──────┘              │
  └─────┼────────┼────────┼────────┼────────────────────────────┘
        │        │        │        │
        ▼        │        │        │
  ┌───────────┐  │        │        │
  │MANAJEMEN  │  │        │        │
  │USER       │  │        │        │
  │           │  │        │        │
  │• CRUD User│  │        │        │
  │• Assign   │  │        │        │
  │  Role     │  │        │        │
  │• Freeze   │  │        │        │
  │  Wallet   │  │        │        │
  └───────────┘  │        │        │
                 ▼        │        │
           ┌───────────┐  │        │
           │AUDIT LOG  │  │        │
           │           │  │        │
           │• Filter   │  │        │
           │  by date  │  │        │
           │• Filter   │  │        │
           │  by user  │  │        │
           │• Export   │  │        │
           └───────────┘  │        │
                          ▼        │
              ┌───────────────┐    │
              │ REKONSILIASI  │    │
              │               │    │
              │ Cek: Wallet   │    │
              │ vs Ledger     │    │
              │               │    │
              │ Status: ✓ OK  │    │
              │               │    │
              │ [Koreksi]     │    │
              └───────────────┘    │
                                   ▼
                         ┌───────────────┐
                         │ IMPERSONATION │
                         │               │
                         │ Lihat sebagai:│
                         │ • Dosen X     │
                         │ • Mahasiswa Y │
                         │               │
                         │ [READ ONLY]   │
                         └───────────────┘
```

---

## 7.2 System Flow

### 7.2.1 Sinkronisasi Poin dari Aplikasi Lama (Pull API)

```
┌─────────────────────────────────────────────────────────────────┐
│                 SYNC FLOW - PULL API                             │
└─────────────────────────────────────────────────────────────────┘

  ┌───────────────┐         ┌───────────────┐         ┌───────────┐
  │ EXTERNAL APP  │         │ WALLET SYSTEM │         │  DATABASE │
  │ (App Lama)    │         │   (BACKEND)   │         │   (MySQL) │
  └───────┬───────┘         └───────┬───────┘         └─────┬─────┘
          │                         │                       │
          │                         │                       │
          │      SCHEDULED JOB (every 5 min)               │
          │                ┌────────┴────────┐              │
          │                │                 │              │
          │◄───────────────┤ GET /api/points │              │
          │                │ ?since=timestamp│              │
          │                │                 │              │
          │────────────────►                 │              │
          │  Response:     │                 │              │
          │  [{            │                 │              │
          │    user_id,    │                 │              │
          │    points,     │                 │              │
          │    type,       │                 │              │
          │    timestamp   │                 │              │
          │  }]            │                 │              │
          │                │                 │              │
          │                │ For each record:│              │
          │                │                 │              │
          │                │ 1. Check if     │              │
          │                │    already synced│             │
          │                │    ─────────────────────────► │
          │                │                 │   Query     │
          │                │                 │◄───────────  │
          │                │                 │              │
          │                │ 2. If not synced,│             │
          │                │    create entry │              │
          │                │    ─────────────────────────► │
          │                │                 │   INSERT    │
          │                │                 │   external_ │
          │                │                 │   transactions│
          │                │                 │◄───────────  │
          │                │                 │              │
          │                │ 3. Credit wallet│              │
          │                │    (if valid)   │              │
          │                │    ─────────────────────────► │
          │                │                 │   UPDATE    │
          │                │                 │   wallets   │
          │                │                 │   INSERT    │
          │                │                 │   ledger    │
          │                │                 │◄───────────  │
          │                │                 │              │
          │                │ 4. Update sync  │              │
          │                │    status       │              │
          │                │    ─────────────────────────► │
          │                │                 │   UPDATE    │
          │                │                 │◄───────────  │
          │                │                 │              │
          │                └─────────────────┘              │
          │                                                 │
```

### 7.2.2 Alur Transaksi QR End-to-End

```
┌─────────────────────────────────────────────────────────────────┐
│              END-TO-END QR TRANSACTION                           │
└─────────────────────────────────────────────────────────────────┘

 DOSEN           BACKEND            DATABASE           MAHASISWA
   │                │                   │                   │
   │ 1. Create QR   │                   │                   │
   │───────────────►│                   │                   │
   │                │ INSERT qr_codes   │                   │
   │                │──────────────────►│                   │
   │                │◄──────────────────│                   │
   │◄───────────────│                   │                   │
   │ QR Code +      │                   │                   │
   │ Image          │                   │                   │
   │                │                   │                   │
   │ (Display QR)   │                   │                   │
   │                │                   │                   │
   │                │                   │   2. Scan QR      │
   │                │                   │◄──────────────────│
   │                │◄──────────────────│                   │
   │                │                   │   Process QR      │
   │                │                   │                   │
   │                │ BEGIN TRANSACTION │                   │
   │                │──────────────────►│                   │
   │                │                   │                   │
   │                │ Lock QR           │                   │
   │                │ Lock Payer Wallet │                   │
   │                │ Lock Payee Wallet │                   │
   │                │                   │                   │
   │                │ Validate:         │                   │
   │                │ - QR valid        │                   │
   │                │ - Balance enough  │                   │
   │                │                   │                   │
   │                │ Debit Payer       │                   │
   │                │ Credit Payee      │                   │
   │                │ Insert Ledgers    │                   │
   │                │ Insert Transaction│                   │
   │                │ Mark QR Used      │                   │
   │                │ Insert Audit      │                   │
   │                │                   │                   │
   │                │ COMMIT            │                   │
   │                │◄──────────────────│                   │
   │                │                   │                   │
   │                │───────────────────────────────────────►│
   │                │                   │   Success Response│
   │ 3. Notification│                   │   New Balance     │
   │◄───────────────│                   │                   │
   │ +1000 points   │                   │                   │
   │ received!      │                   │                   │
   │                │                   │                   │
```

### 7.2.3 Error & Rollback Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                 ERROR & ROLLBACK FLOW                            │
└─────────────────────────────────────────────────────────────────┘

  REQUEST
     │
     ▼
  ┌─────────────────────┐
  │ START TRANSACTION   │
  └──────────┬──────────┘
             │
             ▼
  ┌─────────────────────┐     ┌─────────────────────────────────┐
  │ STEP 1: Lock QR     │────►│ ERROR: QR Not Found             │
  └──────────┬──────────┘     │ ACTION: ROLLBACK                │
             │                │ RESPONSE: 404 QR_NOT_FOUND      │
             │ OK             └─────────────────────────────────┘
             ▼
  ┌─────────────────────┐     ┌─────────────────────────────────┐
  │ STEP 2: Validate QR │────►│ ERROR: QR Expired/Used          │
  └──────────┬──────────┘     │ ACTION: ROLLBACK                │
             │                │ RESPONSE: 410 QR_EXPIRED or     │
             │ OK             │          409 QR_ALREADY_USED    │
             ▼                └─────────────────────────────────┘
  ┌─────────────────────┐     ┌─────────────────────────────────┐
  │ STEP 3: Lock Wallet │────►│ ERROR: Wallet Not Found/Frozen  │
  └──────────┬──────────┘     │ ACTION: ROLLBACK                │
             │                │ RESPONSE: 404 WALLET_NOT_FOUND  │
             │ OK             │          403 WALLET_FROZEN      │
             ▼                └─────────────────────────────────┘
  ┌─────────────────────┐     ┌─────────────────────────────────┐
  │ STEP 4: Check       │────►│ ERROR: Insufficient Balance      │
  │         Balance     │     │ ACTION: ROLLBACK                │
  └──────────┬──────────┘     │ RESPONSE: 402 INSUFFICIENT_     │
             │                │          BALANCE                 │
             │ OK             └─────────────────────────────────┘
             ▼
  ┌─────────────────────┐     ┌─────────────────────────────────┐
  │ STEP 5-9: Execute   │────►│ ERROR: Any DB Error             │
  │ Debit/Credit/Ledger │     │ ACTION: ROLLBACK                │
  └──────────┬──────────┘     │ LOG: Error details for debug    │
             │                │ RESPONSE: 500 INTERNAL_ERROR    │
             │ OK             └─────────────────────────────────┘
             ▼
  ┌─────────────────────┐     ┌─────────────────────────────────┐
  │ COMMIT TRANSACTION  │────►│ ERROR: Commit Failed            │
  └──────────┬──────────┘     │ ACTION: Transaction auto-       │
             │                │         rollback by DB          │
             │ OK             │ RESPONSE: 500 COMMIT_FAILED     │
             ▼                └─────────────────────────────────┘
  ┌─────────────────────┐
  │ SUCCESS RESPONSE    │
  │ 200 OK              │
  │ Transaction details │
  └─────────────────────┘
```
